name: Deploy Monitoring

on:
  push:
    branches:
      - ci-cd
    paths:
      - 'apps/backend/monitoring/**'
      - 'apps/backend/docker-compose.o11y.yaml'
      - '.github/workflows/deploy-monitoring.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GRAFANA_ADMIN_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
      GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Generate Prometheus targets dynamically
        run: |
          mkdir -p apps/backend/monitoring/prometheus/targets

          # Backend 서버들 (Service=rest-api, socketio) - Private IP 사용
          BACKEND_IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Role,Values=backend" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PrivateIpAddress' \
            --output text | tr '\t' '\n' | grep -v '^$')

          # Frontend 서버들 (Role=frontend) - Private IP 사용
          FRONTEND_IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Role,Values=frontend" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PrivateIpAddress' \
            --output text | tr '\t' '\n' | grep -v '^$')

          # MongoDB (Service=mongodb) - Private IP 사용
          MONGODB_IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Service,Values=mongodb" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PrivateIpAddress' \
            --output text | tr '\t' '\n' | grep -v '^$')

          # Redis (Service=redis) - Private IP 사용
          REDIS_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Service,Values=redis" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PrivateIpAddress' \
            --output text)

          # spring-boot.prod.yml (Backend - Actuator metrics)
          echo "# Auto-generated - Backend servers" > apps/backend/monitoring/prometheus/targets/spring-boot.prod.yml
          for ip in $BACKEND_IPS; do
            cat >> apps/backend/monitoring/prometheus/targets/spring-boot.prod.yml << EOF
          - targets: ['${ip}:5001']
            labels:
              application: 'ktb-chat-backend'
              environment: 'production'
              cluster: 'backend'
          EOF
          done

          # nextjs.prod.yml (Frontend - Next.js metrics)
          echo "# Auto-generated - Frontend servers" > apps/backend/monitoring/prometheus/targets/nextjs.prod.yml
          for ip in $FRONTEND_IPS; do
            cat >> apps/backend/monitoring/prometheus/targets/nextjs.prod.yml << EOF
          - targets: ['${ip}:3000']
            labels:
              application: 'ktb-chat-frontend'
              environment: 'production'
              cluster: 'frontend'
          EOF
          done

          # mongodb.prod.yml (MongoDB Exporter - 3대)
          echo "# Auto-generated - MongoDB servers" > apps/backend/monitoring/prometheus/targets/mongodb.prod.yml
          for ip in $MONGODB_IPS; do
            cat >> apps/backend/monitoring/prometheus/targets/mongodb.prod.yml << EOF
          - targets: ['${ip}:9216']
            labels:
              environment: 'production'
              service: 'mongodb'
              cluster: 'mongodb'
          EOF
          done

          # redis.prod.yml
          cat > apps/backend/monitoring/prometheus/targets/redis.prod.yml << EOF
          # Auto-generated - Redis server
          - targets: ['${REDIS_IP}:9121']
            labels:
              environment: 'production'
              service: 'redis'
              cluster: 'redis'
          EOF

          # node-exporters.prod.yml (모든 서버의 Node Exporter)
          echo "# Auto-generated - Node Exporters" > apps/backend/monitoring/prometheus/targets/node-exporters.prod.yml
          for ip in $BACKEND_IPS; do
            cat >> apps/backend/monitoring/prometheus/targets/node-exporters.prod.yml << EOF
          - targets: ['${ip}:9100']
            labels:
              environment: 'production'
              cluster: 'backend'
          EOF
          done
          for ip in $FRONTEND_IPS; do
            cat >> apps/backend/monitoring/prometheus/targets/node-exporters.prod.yml << EOF
          - targets: ['${ip}:9100']
            labels:
              environment: 'production'
              cluster: 'frontend'
          EOF
          done
          for ip in $MONGODB_IPS; do
            cat >> apps/backend/monitoring/prometheus/targets/node-exporters.prod.yml << EOF
          - targets: ['${ip}:9100']
            labels:
              environment: 'production'
              cluster: 'mongodb'
              service: 'mongodb'
          EOF
          done
          cat >> apps/backend/monitoring/prometheus/targets/node-exporters.prod.yml << EOF
          - targets: ['${REDIS_IP}:9100']
            labels:
              environment: 'production'
              cluster: 'redis'
              service: 'redis'
          EOF

          # Observer 서버 (Role=observer)
          OBSERVER_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Role,Values=observer" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PublicIpAddress' \
            --output text | tr -d '\t\n')

          # Observer 서버 Node Exporter 추가
          cat >> apps/backend/monitoring/prometheus/targets/node-exporters.prod.yml << EOF
          - targets: ['${OBSERVER_IP}:9100']
            labels:
              environment: 'production'
              cluster: 'observer'
          EOF

          echo "Generated target files:"
          ls -la apps/backend/monitoring/prometheus/targets/

      - name: Deploy to ktb-chat-observer
        run: |
          # Get ktb-chat-observer server IP
          SERVER=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=ktb-chat-observer" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          echo "Deploying to ktb-chat-observer: $SERVER"
          
          # Check if Docker is installed
          DOCKER_EXISTS=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SERVER 'command -v docker >/dev/null && echo "true" || echo "false"')
          
          if [ "$DOCKER_EXISTS" = "false" ]; then
            echo "Installing Docker on $SERVER..."
            ssh -i ~/.ssh/id_rsa ubuntu@$SERVER << 'DOCKER_INSTALL'
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              sudo usermod -aG docker ubuntu
          DOCKER_INSTALL
          fi

          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SERVER" >> ~/.ssh/known_hosts 2>/dev/null || true

          # Create remote directories
          ssh -i ~/.ssh/id_rsa ubuntu@$SERVER "mkdir -p /home/ubuntu/monitoring/prometheus/targets /home/ubuntu/monitoring/grafana/provisioning/datasources /home/ubuntu/monitoring/grafana/provisioning/dashboards"

          # Copy monitoring configuration files
          scp -i ~/.ssh/id_rsa -r apps/backend/monitoring/* ubuntu@$SERVER:/home/ubuntu/monitoring/
          scp -i ~/.ssh/id_rsa apps/backend/docker-compose.o11y.yaml ubuntu@$SERVER:/home/ubuntu/

          # Deploy monitoring stack
          ssh -i ~/.ssh/id_rsa ubuntu@$SERVER bash << REMOTE_SCRIPT
            cd /home/ubuntu
            sudo docker image prune -a -f
            export ENVIRONMENT=prod
            export GRAFANA_ADMIN_USER="$GRAFANA_ADMIN_USER"
            export GRAFANA_ADMIN_PASSWORD="$GRAFANA_ADMIN_PASSWORD"
            sudo -E docker compose -f docker-compose.o11y.yaml pull
            sudo -E docker compose -f docker-compose.o11y.yaml up -d --force-recreate
          REMOTE_SCRIPT

          # Verify deployment
          sleep 10
          ssh -i ~/.ssh/id_rsa ubuntu@$SERVER "sudo docker ps --filter 'name=prometheus-ktb' --filter 'name=grafana-ktb' --filter 'name=cadvisor' --format 'table {{.Names}}\t{{.Status}}'"

