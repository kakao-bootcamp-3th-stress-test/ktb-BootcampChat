# 스트레스 테스트 가이드

서버가 얼마나 많은 부하를 견딜 수 있는지 확인하는 스트레스 테스트 가이드입니다.

## 스트레스 테스트란?

스트레스 테스트는 점진적으로 부하를 증가시켜 서버의 한계점을 찾는 테스트입니다. 서버가 언제 성능이 저하되기 시작하는지, 언제 실패하기 시작하는지 확인할 수 있습니다.

## 실행 방법

### 기본 스트레스 테스트

```bash
# 점진적으로 부하를 증가시키는 스트레스 테스트
make test-stress
```

이 테스트는 다음 단계로 부하를 증가시킵니다:
1. **1분**: 5명
2. **1분**: 10명
3. **1분**: 20명
4. **1분**: 50명
5. **1분**: 100명
6. **1분**: 200명
7. **1분**: 500명
8. **2분**: 500명 유지 (최대 부하 유지)
9. **1분**: 1000명으로 급증 (극한 테스트)
10. **1분**: 1000명 유지
11. **1분**: 2000명으로 급증
12. **2분**: 2000명 유지
13. **1분**: 3000명으로 급증
14. **2분**: 3000명 유지
15. **2분**: 점진적으로 감소

**총 소요 시간**: 약 19분

### 부하 테스트 (일정한 부하)

```bash
# 일정한 부하를 유지하는 테스트
make test-load

# 더 많은 사용자로 테스트
VUS=100 make test-load
VUS=200 make test-load
VUS=500 make test-load
```

## 결과 해석

### 성공 지표

- **HTTP 요청 실패율**: 10% 미만
- **응답 시간 (p95)**: 2초 미만
- **응답 시간 (p99)**: 5초 미만
- **체크 성공률**: 80% 이상

### 서버 한계 확인 포인트

스트레스 테스트 결과에서 다음을 확인하세요:

1. **성능 저하 시작점**: 응답 시간이 급격히 증가하기 시작하는 사용자 수
2. **에러율 증가 시작점**: HTTP 에러가 10%를 넘기 시작하는 사용자 수
3. **최대 처리 용량**: 서버가 안정적으로 처리할 수 있는 최대 동시 사용자 수
4. **극한 한계**: 서버가 완전히 다운되기 전까지의 최대 부하

## 예상 결과

### 정상적인 서버

```
5명   → ✅ 모든 요청 성공, 응답 시간 < 100ms
10명  → ✅ 모든 요청 성공, 응답 시간 < 200ms
20명  → ✅ 모든 요청 성공, 응답 시간 < 300ms
50명  → ✅ 대부분 성공, 응답 시간 < 500ms
100명 → ⚠️  일부 실패 가능, 응답 시간 < 1s
200명 → ⚠️  실패율 증가, 응답 시간 < 2s
500명 → ❌ 실패율 높음, 응답 시간 > 2s
1000명 → ❌ 많은 실패, 응답 시간 매우 높음
```

### 결과 분석 예시

```
http_req_duration: avg=1.2s, min=50ms, med=800ms, max=10s, p(90)=2.5s, p(95)=3.5s
http_req_failed: rate=0.15 (15% 실패)
checks: rate=0.85 (85% 성공)
```

이 경우:
- **평균 응답 시간**: 1.2초 (양호)
- **p95 응답 시간**: 3.5초 (임계값 2초 초과)
- **실패율**: 15% (임계값 10% 초과)
- **결론**: 약 200-300명 정도가 안정적인 한계로 보임

## 주의사항

⚠️ **중요**: 스트레스 테스트는 실제 서버에 매우 높은 부하를 줍니다!

1. **프로덕션 환경에서는 실행하지 마세요**
   - 테스트 서버나 스테이징 환경에서만 실행
   - 프로덕션에 영향을 줄 수 있음

2. **서버 모니터링**
   - CPU, 메모리, 네트워크 사용량 모니터링
   - 데이터베이스 연결 수 확인
   - 로그 확인

3. **점진적 실행**
   - 처음에는 낮은 부하로 시작
   - 서버 상태를 확인하면서 점진적으로 증가

4. **데이터 정리**
   - 테스트 후 생성된 테스트 데이터 정리
   - DB 용량 확인

## 커스터마이징

### 더 높은 부하로 테스트

`scenarios/stress.scenario.js` 파일을 수정하여 더 높은 부하를 설정할 수 있습니다:

```javascript
stages: [
  { duration: '1m', target: 100 },
  { duration: '1m', target: 500 },
  { duration: '1m', target: 1000 },
  { duration: '1m', target: 2000 },
  { duration: '1m', target: 3000 },  // 3000명까지 증가
  { duration: '1m', target: 5000 },  // 5000명까지 증가
  { duration: '2m', target: 5000 },
  { duration: '2m', target: 0 },
],
```

### 더 긴 테스트

```javascript
stages: [
  { duration: '5m', target: 100 },  // 5분 동안 100명 유지
  { duration: '5m', target: 200 },
  { duration: '5m', target: 500 },
  { duration: '2m', target: 0 },
],
```

## 트러블슈팅

### 임계값(Thresholds) 에러 발생

**에러 메시지:**
```
ERRO[0780] thresholds on metrics 'checks, http_req_duration, http_req_failed' have been crossed 
make: *** [test-stress] Error 99
```

**원인:**
스트레스 테스트는 서버의 한계를 찾는 것이므로, 높은 부하에서 임계값을 초과하는 것이 **정상**입니다. 이는 서버가 한계에 도달했다는 의미입니다.

**해결 방법:**

1. **임계값 검사 비활성화 (권장)**
   ```bash
   DISABLE_THRESHOLDS=true make test-stress
   ```
   이렇게 하면 임계값을 완전히 무시하고 테스트 결과만 확인할 수 있습니다.

2. **임계값이 더 관대하게 조정됨**
   - 실패율: 50% 미만 (기존 10%)
   - 응답 시간: p95 < 10초, p99 < 30초 (기존 2초, 5초)
   - 체크 성공률: 50% 이상 (기존 80%)
   
   그래도 에러가 발생하면 위의 방법 1을 사용하세요.

**중요:** 스트레스 테스트의 목적은 서버가 **언제** 한계에 도달하는지 확인하는 것이므로, 임계값 에러는 예상된 동작입니다. 테스트 결과의 통계 데이터를 확인하여 서버의 성능 한계를 파악하세요.

### 메모리 부족

```bash
# 동시 사용자 수를 줄여서 테스트
# stress.scenario.js에서 최대 사용자 수를 낮춤
```

### 네트워크 타임아웃

```bash
# 타임아웃 증가
TIMEOUT=60s make test-stress
```

### 서버가 응답하지 않음

1. 테스트 중단 (Ctrl+C)
2. 서버 상태 확인
3. 부하를 낮춰서 다시 테스트

## 권장 테스트 순서

1. **기본 테스트**: `make test` (10명, 2분)
2. **부하 테스트**: `VUS=50 make test-load` (50명, 5분)
3. **부하 테스트**: `VUS=100 make test-load` (100명, 5분)
4. **스트레스 테스트**: `make test-stress` (점진적 증가, 19분)
   - 임계값 에러가 발생하면: `DISABLE_THRESHOLDS=true make test-stress`

각 단계에서 서버 상태를 확인하고, 문제가 없으면 다음 단계로 진행하세요.

